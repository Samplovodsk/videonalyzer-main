<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è</p>
        </div>

        <div class="main-content">
            <div class="video-section">
                <div class="camera-controls">
                    <div class="camera-status">
                        <div class="status-indicator" id="cameraIndicator"></div>
                        <span id="cameraStatusText">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>
                    </div>
                    <div class="controls">
                        <button class="btn btn-primary" id="toggleCameraBtn" onclick="toggleCamera()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
                        <button class="btn btn-secondary" id="toggleAnalysisBtn" onclick="toggleAnalysis()" disabled style="display:none;">–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
                    </div>
                </div>
                
                <div class="video-container">
                    <div class="video-placeholder" id="videoPlaceholder">
                        <div class="camera-icon">üì∑</div>
                        <p>–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</p>
                    </div>
                    <video id="videoElement" autoplay muted style="display: none;"></video>
                    <div class="video-overlay" id="videoOverlay" style="display: none;">
                        –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    </div>
                </div>
                
                <div class="offline-video" style="margin-top:20px;">
                    <h3 class="section-title">–ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ</h3>
                    <div class="controls" style="margin-bottom:10px; gap:10px;">
                        <input type="file" id="videoFileInput" accept="video/*" style="display:none;">
                        <label for="videoFileInput" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ</label>
                        <span id="videoFileName" style="color:#555;"></span>
                    </div>
                    <video id="localVideo" controls style="width:100%; max-height:360px; display:none;"></video>
                </div>

                <div id="alerts"></div>

                <div class="detection-info" id="detectionInfo" style="display: none;">
                    <h3>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:</h3>
                    <div id="detectionList"></div>
                </div>
            </div>

            <div class="status-panel">
                <h3 class="section-title">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                <div class="status-item">
                    <span class="status-label">–ö–∞–º–µ—Ä–∞:</span>
                    <span class="status-value status-inactive" id="cameraStatus">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                </div>
                <div class="status-item">
                    <span class="status-label">–ê–Ω–∞–ª–∏–∑:</span>
                    <span class="status-value status-inactive" id="analysisStatus">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                </div>
                <div class="status-item">
                    <span class="status-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–∞–¥—Ä–æ–≤:</span>
                    <span class="status-value" id="frameCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">–°–æ–±—ã—Ç–∏—è:</span>
                    <span class="status-value" id="eventCount">0</span>
                </div>
            </div>
        </div>

        <div class="events-section">
            <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;">
                <span>–°–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</span>
                <div>
                    <button class="btn btn-secondary" onclick="toggleMetrics()" style="margin-right: 10px;">–ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏</button>
                    <button class="btn btn-warning" onclick="clearEvents()">–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏—è</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h4 style="margin-bottom:10px;">–≠—Ñ–∏—Ä</h4>
                    <div id="liveEventsList"></div>
                </div>
                <div>
                    <h4 style="margin-bottom:10px;">–ì–æ—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ</h4>
                    <div id="videoEventsList"></div>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫ -->
        <div class="metrics-section" id="metricsSection" style="display: none;">
            <div class="section-title">–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏</div>
            
            <!-- –¢–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
            <div class="metrics-summary">
                <div class="metric-card">
                    <div class="metric-value" id="totalDetections">0</div>
                    <div class="metric-label">–í—Å–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–π</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgFPS">0.0</div>
                    <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π FPS</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidence">0.0</div>
                    <div class="metric-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="precision">0.0</div>
                    <div class="metric-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="charts-container">
                <div class="chart-section">
                    <h4>ROC-–∫—Ä–∏–≤–∞—è</h4>
                    <div class="chart-placeholder" id="rocChart">
                        <img id="rocImage" style="max-width: 100%; height: auto; display: none;">
                        <div class="loading-chart">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...</div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h4>–ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫</h4>
                    <div class="chart-placeholder" id="confusionChart">
                        <img id="confusionImage" style="max-width: 100%; height: auto; display: none;">
                        <div class="loading-chart">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...</div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h4>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h4>
                    <div class="chart-placeholder" id="performanceChart">
                        <img id="performanceImage" style="max-width: 100%; height: auto; display: none;">
                        <div class="loading-chart">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...</div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤</h4>
                    <div class="chart-placeholder" id="distributionChart">
                        <img id="distributionImage" style="max-width: 100%; height: auto; display: none;">
                        <div class="loading-chart">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...</div>
                    </div>
                </div>
            </div>

            <div class="metrics-controls">
                <button class="btn btn-primary" onclick="refreshMetrics()">–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏</button>
                <button class="btn btn-secondary" onclick="exportReport()">–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞</button>
            </div>
        </div>
    </div>

    <script>
        let video = document.getElementById('videoElement');
        let videoPlaceholder = document.getElementById('videoPlaceholder');
        let videoOverlay = document.getElementById('videoOverlay');
        let isAnalyzing = false;
        let isCameraActive = false;
        let frameCount = 0;
        let eventCount = 0;
        let analysisInterval;
        let currentStream = null;
        let localVideo = document.getElementById('localVideo');
        let localVideoUrl = null;
        let localAnalysisInterval;
        let localRafId = null;
        let lastLocalCapture = 0;
        const LOCAL_TARGET_INTERVAL_MS = 200; // ~5 FPS
        let liveEvents = [];
        let videoSessionEvents = [];

        // –¢–æ–≥–≥–ª –∫–∞–º–µ—Ä—ã
        async function toggleCamera() {
            if (isCameraActive) { stopCamera(); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480 
                    } 
                });
                
                currentStream = stream;
                video.srcObject = stream;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Å–∫—Ä—ã–≤–∞–µ–º placeholder
                video.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                videoOverlay.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                updateCameraStatus(true);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('toggleCameraBtn').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É';
                document.getElementById('toggleCameraBtn').className = 'btn btn-warning';
                document.getElementById('toggleAnalysisBtn').disabled = false;
                
                showAlert('–ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞', 'success');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
                toggleAnalysis();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã: ' + error.message, 'danger');
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
        function stopCamera() {
            if (currentStream) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
            if (isAnalyzing) {
                stopAnalysis();
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
            video.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            videoOverlay.style.display = 'none';
            video.srcObject = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            updateCameraStatus(false);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('toggleCameraBtn').textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É';
            document.getElementById('toggleCameraBtn').className = 'btn btn-primary';
            document.getElementById('toggleAnalysisBtn').disabled = true;
            document.getElementById('toggleAnalysisBtn').textContent = '–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑';
            document.getElementById('toggleAnalysisBtn').className = 'btn btn-secondary';
            
            showAlert('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–º–µ—Ä—ã
        function updateCameraStatus(active) {
            isCameraActive = active;
            const statusText = document.getElementById('cameraStatusText');
            const indicator = document.getElementById('cameraIndicator');
            
            if (active) {
                statusText.textContent = '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞';
                indicator.className = 'status-indicator active';
                document.getElementById('cameraStatus').textContent = '–ê–∫—Ç–∏–≤–Ω–∞';
                document.getElementById('cameraStatus').className = 'status-value status-active';
            } else {
                statusText.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞';
                indicator.className = 'status-indicator';
                document.getElementById('cameraStatus').textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
                document.getElementById('cameraStatus').className = 'status-value status-inactive';
            }
        }

        // –¢–æ–≥–≥–ª –∞–Ω–∞–ª–∏–∑–∞
        async function toggleAnalysis() {
            if (isAnalyzing) { await stopAnalysis(); return; }
            if (!isCameraActive) {
                showAlert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µ—Ä—É', 'danger');
                return;
            }
            try {
                const response = await fetch('/api/start_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'started') {
                    isAnalyzing = true;
                    document.getElementById('analysisStatus').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                    document.getElementById('analysisStatus').className = 'status-value status-active';
                    document.getElementById('toggleAnalysisBtn').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
                    document.getElementById('toggleAnalysisBtn').className = 'btn btn-danger';
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∫–∞–¥—Ä–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    startFrameCapture();
                    startResultPolling();
                    showAlert('–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω', 'success');
                } else {
                    showAlert(result.message, 'info');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏–∑–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'danger');
            }
        }

        async function stopAnalysis() {
            try {
                const response = await fetch('/api/stop_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                isAnalyzing = false;
                document.getElementById('analysisStatus').textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                document.getElementById('analysisStatus').className = 'status-value status-inactive';
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('toggleAnalysisBtn').textContent = '–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑';
                document.getElementById('toggleAnalysisBtn').className = 'btn btn-secondary';
                
                if (analysisInterval) {
                    clearInterval(analysisInterval);
                }
                
                showAlert('–ê–Ω–∞–ª–∏–∑ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–Ω–∞–ª–∏–∑–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'danger');
            }
        }

        // –ó–∞—Ö–≤–∞—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–¥—Ä–æ–≤
        function startFrameCapture() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            analysisInterval = setInterval(async () => {
                if (isAnalyzing && isCameraActive && video.videoWidth > 0) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    const frameData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    try {
                        const response = await fetch('/api/upload_frame', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ frame: frameData })
                        });
                        
                        if (response.ok) {
                            frameCount++;
                            document.getElementById('frameCount').textContent = frameCount;
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–∞–¥—Ä–∞:', error);
                    }
                }
            }, 1000); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–¥—Ä –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        }

        // ===== –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ (–æ—Ñ–ª–∞–π–Ω) =====
        function loadLocalVideo() {
            const input = document.getElementById('videoFileInput');
            if (!input.files || input.files.length === 0) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª', 'warning');
                return;
            }
            const file = input.files[0];
            if (localVideoUrl) URL.revokeObjectURL(localVideoUrl);
            localVideoUrl = URL.createObjectURL(file);
            localVideo.src = localVideoUrl;
            localVideo.style.display = 'block';
            document.getElementById('playLocalBtn').disabled = false;
            document.getElementById('pauseLocalBtn').disabled = false;
            document.getElementById('analyzeLocalBtn').disabled = false;
            showAlert('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.', 'success');
        }

        function playLocalVideo() {
            localVideo.play();
            startLocalCaptureLoop();
        }

        function pauseLocalVideo() {
            localVideo.pause();
            if (localRafId) {
                cancelAnimationFrame(localRafId);
                localRafId = null;
            }
        }

        async function toggleLocalAnalysis() {
            if (!localVideo.src) {
                showAlert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ—Ñ–∞–π–ª', 'danger');
                return;
            }
            if (!isAnalyzing) {
                try {
                    const response = await fetch('/api/start_analysis', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                    const result = await response.json();
                    if (result.status !== 'started' && result.status !== 'already_running') {
                        showAlert(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑', 'danger');
                        return;
                    }
                    isAnalyzing = true;
                    document.getElementById('analysisStatus').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                    document.getElementById('analysisStatus').className = 'status-value status-active';
                    startLocalCaptureLoop();
                    startResultPolling();
                    showAlert('–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω', 'success');
                } catch (e) {
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + e.message, 'danger');
                }
            } else {
                await stopAnalysis();
                if (localAnalysisInterval) clearInterval(localAnalysisInterval);
                if (localRafId) { cancelAnimationFrame(localRafId); localRafId = null; }
            }
        }

        function startLocalCaptureLoop() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const loop = async (ts) => {
                if (!localVideo.paused && !localVideo.ended) {
                    const elapsed = ts - lastLocalCapture;
                    if (elapsed >= LOCAL_TARGET_INTERVAL_MS) {
                        lastLocalCapture = ts;
                        if (isAnalyzing && localVideo.readyState >= 2) {
                            canvas.width = localVideo.videoWidth;
                            canvas.height = localVideo.videoHeight;
                            ctx.drawImage(localVideo, 0, 0);
                            const frameData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                            try {
                                const response = await fetch('/api/upload_frame', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ frame: frameData })
                                });
                                if (response.ok) {
                                    frameCount++;
                                    document.getElementById('frameCount').textContent = frameCount;
                                }
                            } catch (e) {
                                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–¥—Ä–∞ –≤–∏–¥–µ–æ:', e);
                            }
                        }
                    }
                }
                localRafId = requestAnimationFrame(loop);
            };
            if (!localRafId) localRafId = requestAnimationFrame(loop);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        document.getElementById('videoFileInput').addEventListener('change', () => {
            const input = document.getElementById('videoFileInput');
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];
            document.getElementById('videoFileName').textContent = file.name;
            if (localVideoUrl) URL.revokeObjectURL(localVideoUrl);
            localVideoUrl = URL.createObjectURL(file);
            localVideo.src = localVideoUrl;
            localVideo.style.display = 'block';
            videoSessionEvents = [];
            renderVideoEvents();
            showAlert('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–∏—Ç–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞.', 'success');
        });

        localVideo.addEventListener('play', async () => {
            try {
                const response = await fetch('/api/start_analysis', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const result = await response.json();
                if (result.status === 'started' || result.status === 'already_running') {
                    isAnalyzing = true;
                    document.getElementById('analysisStatus').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                    document.getElementById('analysisStatus').className = 'status-value status-active';
                    startLocalCaptureLoop();
                    startResultPolling();
                }
            } catch (e) { /* ignore */ }
        });

        async function stopLocalAnalysis() {
            if (isAnalyzing) {
                await stopAnalysis();
            }
            if (localRafId) { cancelAnimationFrame(localRafId); localRafId = null; }
        }

        localVideo.addEventListener('pause', () => { stopLocalAnalysis(); });
        localVideo.addEventListener('ended', () => { stopLocalAnalysis(); });

        // –û—á–∏—Å—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
        async function clearEvents() {
            try {
                const resp = await fetch('/api/clear_events', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const res = await resp.json();
                if (res.status === 'success') {
                    eventCount = 0;
                    document.getElementById('eventCount').textContent = eventCount;
                    liveEvents = [];
                    videoSessionEvents = [];
                    renderLiveEvents();
                    renderVideoEvents();
                    showAlert('–°–æ–±—ã—Ç–∏—è –æ—á–∏—â–µ–Ω—ã', 'success');
                } else {
                    showAlert(res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏—è', 'danger');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π: ' + e.message, 'danger');
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
        function startResultPolling() {
            const pollResults = async () => {
                if (!isAnalyzing) return;
                
                try {
                    const response = await fetch('/api/get_results');
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.data) {
                        displayAnalysisResults(result.data);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                }
                
                setTimeout(pollResults, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            };
            
            pollResults();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
        function displayAnalysisResults(data) {
            const detectionInfo = document.getElementById('detectionInfo');
            const detectionList = document.getElementById('detectionList');
            
            if (data.detections && data.detections.length > 0) {
                detectionInfo.style.display = 'block';
                detectionList.innerHTML = '';
                
                data.detections.forEach(detection => {
                    const item = document.createElement('div');
                    item.className = 'detection-item';
                    item.innerHTML = `
                        <span class="detection-class">${detection.class}</span>
                        <span class="detection-confidence">${(detection.confidence * 100).toFixed(1)}%</span>
                    `;
                    detectionList.appendChild(item);
                });
            } else {
                detectionInfo.style.display = 'none';
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            if (data.suspicious_events && data.suspicious_events.length > 0) {
                const isLive = isCameraActive;
                data.suspicious_events.forEach(ev => {
                    eventCount++;
                    document.getElementById('eventCount').textContent = eventCount;
                    if (isLive) {
                        liveEvents.push({
                            time: new Date().toISOString(),
                            description: ev.description,
                            type: ev.type,
                            confidence: ev.confidence,
                            frame_b64: ev.frame_b64 || null
                        });
                        renderLiveEvents();
                    } else if (localVideo && !localVideo.paused) {
                        videoSessionEvents.push({
                            timeSec: localVideo.currentTime,
                            description: ev.description,
                            type: ev.type,
                            confidence: ev.confidence
                        });
                        renderVideoEvents();
                    }
                    showAlert(`–í–ù–ò–ú–ê–ù–ò–ï: ${ev.description}`, 'danger');
                });
            }
        }

        // –†–µ–Ω–¥–µ—Ä –ª–æ–≥–æ–≤ —Å–æ–±—ã—Ç–∏–π (—Ä–∞–∑–¥–µ–ª—å–Ω–æ)
        function renderLiveEvents() {
            const container = document.getElementById('liveEventsList');
            if (!container) return;
            if (liveEvents.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding: 10px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
                return;
            }
            container.innerHTML = '';
            liveEvents.slice().reverse().forEach(ev => {
                const item = document.createElement('div');
                item.className = 'event-item';
                item.innerHTML = `
                    <div class="event-header">
                        <span class="event-type">–≠—Ñ–∏—Ä ¬∑ ${ev.type}</span>
                        <span class="event-time">${new Date(ev.time).toLocaleString('ru-RU')}</span>
                    </div>
                    <div class="event-description">${ev.description}</div>
                    <div class="event-confidence">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(ev.confidence * 100).toFixed(1)}%</div>
                    ${ev.frame_b64 ? '<img src="data:image/jpeg;base64,' + ev.frame_b64 + '" style="width:100%;margin-top:8px;border-radius:8px;" />' : ''}
                `;
                container.appendChild(item);
            });
        }

        function renderVideoEvents() {
            const container = document.getElementById('videoEventsList');
            if (!container) return;
            if (videoSessionEvents.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding: 10px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
                return;
            }
            container.innerHTML = '';
            videoSessionEvents.slice().reverse().forEach(ev => {
                const item = document.createElement('div');
                item.className = 'event-item';
                item.style.cursor = 'pointer';
                item.title = '–ü–µ—Ä–µ–π—Ç–∏ –∫ ' + formatTime(ev.timeSec);
                item.addEventListener('click', () => {
                    if (localVideo) {
                        localVideo.currentTime = ev.timeSec;
                        localVideo.play();
                    }
                });
                item.innerHTML = `
                    <div class="event-header">
                        <span class="event-type">–í–∏–¥–µ–æ ¬∑ ${ev.type}</span>
                        <span class="event-time">${formatTime(ev.timeSec)}</span>
                    </div>
                    <div class="event-description">${ev.description}</div>
                    <div class="event-confidence">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(ev.confidence * 100).toFixed(1)}%</div>
                `;
                container.appendChild(item);
            });
        }

        function formatTime(sec) {
            const s = Math.floor(sec % 60).toString().padStart(2,'0');
            const m = Math.floor((sec / 60) % 60).toString().padStart(2,'0');
            const h = Math.floor(sec / 3600);
            return (h > 0 ? h + ':' : '') + m + ':' + s;
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // –ú–µ—Ç—Ä–∏–∫–∏
        let metricsVisible = false;
        let metricsInterval = null;

        function toggleMetrics() {
            const metricsSection = document.getElementById('metricsSection');
            metricsVisible = !metricsVisible;
            
            if (metricsVisible) {
                metricsSection.style.display = 'block';
                document.querySelector('[onclick="toggleMetrics()"]').textContent = '–°–∫—Ä—ã—Ç—å –º–µ—Ç—Ä–∏–∫–∏';
                refreshMetrics();
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                metricsInterval = setInterval(refreshMetrics, 10000);
            } else {
                metricsSection.style.display = 'none';
                document.querySelector('[onclick="toggleMetrics()"]').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏';
                if (metricsInterval) {
                    clearInterval(metricsInterval);
                    metricsInterval = null;
                }
            }
        }

        async function refreshMetrics() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
                const metricsResponse = await fetch('/api/metrics/current');
                const metricsData = await metricsResponse.json();
                
                if (metricsData.status === 'success') {
                    updateMetricsSummary(metricsData.metrics);
                }

                // –ü–æ–ª—É—á–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                const chartsResponse = await fetch('/api/metrics/charts');
                const chartsData = await chartsResponse.json();
                
                if (chartsData.status === 'success') {
                    updateCharts(chartsData.charts);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ—Ç—Ä–∏–∫', 'danger');
            }
        }

        function updateMetricsSummary(metrics) {
            document.getElementById('totalDetections').textContent = metrics.total_detections || 0;
            document.getElementById('avgFPS').textContent = (metrics.avg_fps || 0).toFixed(1);
            document.getElementById('avgConfidence').textContent = (metrics.avg_confidence || 0).toFixed(3);
            document.getElementById('precision').textContent = (metrics.precision || 0).toFixed(3);
        }

        function updateCharts(charts) {
            // ROC –∫—Ä–∏–≤–∞—è
            if (charts.roc_curve) {
                const rocImg = document.getElementById('rocImage');
                rocImg.src = 'data:image/png;base64,' + charts.roc_curve;
                rocImg.style.display = 'block';
                rocImg.parentElement.querySelector('.loading-chart').style.display = 'none';
            }

            // –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫
            if (charts.confusion_matrix) {
                const confImg = document.getElementById('confusionImage');
                confImg.src = 'data:image/png;base64,' + charts.confusion_matrix;
                confImg.style.display = 'block';
                confImg.parentElement.querySelector('.loading-chart').style.display = 'none';
            }

            // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (charts.performance_chart) {
                const perfImg = document.getElementById('performanceImage');
                perfImg.src = 'data:image/png;base64,' + charts.performance_chart;
                perfImg.style.display = 'block';
                perfImg.parentElement.querySelector('.loading-chart').style.display = 'none';
            }

            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤
            if (charts.class_distribution) {
                const distImg = document.getElementById('distributionImage');
                distImg.src = 'data:image/png;base64,' + charts.class_distribution;
                distImg.style.display = 'block';
                distImg.parentElement.querySelector('.loading-chart').style.display = 'none';
            }
        }

        async function exportReport() {
            try {
                const response = await fetch('/api/metrics/report');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º JSON —Ñ–∞–π–ª
                    const blob = new Blob([JSON.stringify(data.report, null, 2)], 
                                        { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `metrics_report_${new Date().toISOString().slice(0,19)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                } else {
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –æ—Ç—á–µ—Ç–∞', 'danger');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –æ—Ç—á–µ—Ç–∞', 'danger');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            renderLiveEvents();
            renderVideoEvents();
        });
    </script>
</body>
</html>
